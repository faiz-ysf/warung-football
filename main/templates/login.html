{% extends 'base.html' %}

{% block meta %}
<title>Login - Warung Football</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex"
     style="background:linear-gradient(135deg,#0f172a,#1e293b,#006D6F);">

  <!-- Left side -->
  <div class="flex-1 hidden lg:block"></div>

  <!-- Right side panel -->
  <div class="w-full lg:w-1/2 h-screen bg-white/10 backdrop-blur-xl 
              border-l border-white/20 shadow-xl text-white flex items-center justify-center">

    <div class="w-full max-w-md p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Sign In</h1>
        <p class="text-white/80">Welcome back to Warung Football</p>
      </div>

      <!-- Traditional Server Errors -->
      {% if form.non_field_errors %}
        <div class="mb-6 space-y-2">
          {% for error in form.non_field_errors %}
            <div class="px-4 py-3 rounded-md text-sm border bg-red-500/20 border-red-400 text-red-200">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="mb-6 space-y-2">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <div class="px-4 py-3 rounded-md text-sm border bg-red-500/20 border-red-400 text-red-200">
                <strong>{{ field|title }}:</strong> {{ error }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endif %}

      <!-- AJAX States -->
      <div id="loginLoading" class="hidden flex items-center justify-center py-4 text-white/70">
        <div class="animate-spin w-6 h-6 border-2 border-white/30 border-t-[#3AB09E] mr-2 rounded-full"></div>
        Signing in...
      </div>

      <div id="loginEmpty" class="hidden py-12 text-center text-white/70">
        <h3 class="text-lg font-medium mb-2">Ready to Log In</h3>
        <p class="empty-msg text-sm">Enter your credentials to continue.</p>
      </div>

      <div id="loginError" class="hidden p-4 bg-red-500/10 border border-red-400 text-red-200 rounded-md mb-6">
        <h3 class="text-sm font-medium mb-2">Login Failed</h3>
        <p class="error-msg text-xs mb-4">Error details here.</p>
        <!-- Retry button removed -->
      </div>

      <div id="loginSuccess" class="hidden p-4 bg-green-500/10 border border-green-400 text-green-200 rounded-md mb-6">
        <h3 class="text-sm font-medium mb-2">Success!</h3>
        <p class="text-xs">Redirecting to dashboard...</p>
      </div>

      <!-- Content (Form) -->
      <div id="loginContent">
        <form id="loginForm" method="POST" class="space-y-6">
          {% csrf_token %}
          
          <div>
            <label for="username" class="block text-sm font-medium mb-2">Username</label>
            <input id="username" name="username" type="text" required
                   class="w-full px-4 py-3 rounded-md bg-white/90 text-gray-900 
                          focus:outline-none focus:ring-2 focus:ring-[#3AB09E]" 
                   placeholder="Enter your username">
          </div>

          <div>
            <label for="password" class="block text-sm font-medium mb-2">Password</label>
            <input id="password" name="password" type="password" required
                   class="w-full px-4 py-3 rounded-md bg-white/90 text-gray-900
                          focus:outline-none focus:ring-2 focus:ring-[#3AB09E]" 
                   placeholder="Enter your password">
          </div>

          <button type="submit" id="loginSubmit" 
                  class="w-full bg-[#3AB09E] hover:bg-[#39A78D] text-white font-medium py-3 px-4 rounded-md transition-colors">
            Sign In
          </button>
        </form>

        <!-- Footer -->
        <div class="mt-10 text-center border-t border-white/20 pt-6">
          <p class="text-white/70 text-sm">
            Don't have an account? 
            <a href="{% url 'main:register' %}" 
               class="text-[#3AB09E] hover:text-[#39A78D] font-medium">
              Register Now
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== AJAX LOGIN - No Retry Button ==========
console.log("=== AJAX LOGIN - SIMPLIFIED ===");

const form = document.getElementById("loginForm");
const content = document.getElementById("loginContent");
const loading = document.getElementById("loginLoading");
const empty = document.getElementById("loginEmpty");
const error = document.getElementById("loginError");
const success = document.getElementById("loginSuccess");
const submitBtn = document.getElementById("loginSubmit");

function showLoading() {
  content.classList.add("hidden");
  empty.classList.add("hidden");
  error.classList.add("hidden");
  success.classList.add("hidden");
  loading.classList.remove("hidden");
  submitBtn.disabled = true;
  submitBtn.textContent = "Signing In...";
}

function showError(msg = "Login failed") {
  content.classList.remove("hidden");
  loading.classList.add("hidden");
  empty.classList.add("hidden");
  success.classList.add("hidden");
  error.classList.remove("hidden");
  const msgEl = error.querySelector(".error-msg");
  if (msgEl) msgEl.textContent = msg;
  submitBtn.disabled = false;
  submitBtn.textContent = "Sign In";
}

function showSuccess() {
  loading.classList.add("hidden");
  empty.classList.add("hidden");
  error.classList.add("hidden");
  content.classList.add("hidden");
  success.classList.remove("hidden");
  submitBtn.disabled = true;
  submitBtn.textContent = "Logged In!";
}

function showEmpty(msg = "Ready to log in") {
  loading.classList.add("hidden");
  error.classList.add("hidden");
  success.classList.add("hidden");
  empty.classList.remove("hidden");
  const msgEl = empty.querySelector(".empty-msg");
  if (msgEl) msgEl.textContent = msg;
  content.classList.remove("hidden");
}

if (form) {
  async function submitLogin() {
    console.log("=== LOGIN SUBMIT ===");

    showLoading();

    const formData = new FormData(form);
    const jsonData = {
      username: formData.get("username") || "",
      password: formData.get("password") || "",
      csrfmiddlewaretoken: formData.get("csrfmiddlewaretoken") || "",
    };

    try {
      const response = await fetch("{% url 'main:login' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
        },
        body: JSON.stringify(jsonData),
      });

      console.log("Status:", response.status);

      if (response.ok) {
        try {
          const result = await response.json();
          if (result.success) {
            showSuccess();
            if (typeof showToast === 'function') showToast("Success", "Logged in!", "success");
            setTimeout(() => {
              window.location.href = result.redirect || "{% url 'main:show_main' %}";
            }, 1500);
            return;
          }
          throw new Error(result.message || "Login failed");
        } catch (jsonErr) {
          // Fallback to HTML success (traditional backend)
          console.log("Non-JSON response - assuming success");
          showSuccess();
          if (typeof showToast === 'function') showToast("Success", "Logged in!", "success");
          setTimeout(() => {
            window.location.href = "{% url 'main:show_main' %}";
          }, 1500);
          return;
        }
      } else {
        try {
          const errData = await response.json();
          const msg = errData.message || "Invalid credentials";
          throw new Error(msg);
        } catch {
          const text = await response.text();
          const msg = text.includes("invalid") ? "Invalid credentials" : "Server error";
          throw new Error(msg);
        }
      }
    } catch (err) {
      console.error("Login error:", err);
      showError(err.message);
      if (typeof showToast === 'function') showToast("Error", err.message, "error");
    }
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    submitLogin();
  });
} else {
  console.warn("No form - fallback to traditional");
  const emptyEl = document.getElementById("loginEmpty");
  if (emptyEl) emptyEl.classList.remove("hidden");
}

// Initial form visible
content.classList.remove("hidden");
console.log("=== AJAX LOGIN READY ===");
</script>
{% endblock content %}