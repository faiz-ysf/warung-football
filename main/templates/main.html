{% extends 'base.html' %}
{% load static %}
{% block title %}Warung Football{% endblock %}

{% block content %}
{% include 'navbar.html' %}


<!--  
      Where did you left off:
      1.) You where trying to implement AJAX for edit, delete, and read product, but it failed.
      2.) you have not done the other task, like:
          - implementing login and register for AJAX
          - creating loading, Empty, and Error state
          - creating toast for CRUD and login, logout, 
            and register(? why do we need it in the first place)


-->

<div class="min-h-screen pt-24"
     style="background:linear-gradient(135deg,#0f172a,#1e293b,#006D6F);">
  <div class="max-w-7xl mx-auto px-6 lg:px-8 py-10">

    <!-- Header section with Add Product button -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-12 
                bg-white/10 backdrop-blur-md border border-white/20 rounded-xl p-4 shadow">
      <div class="flex space-x-3">
        <a id="filter-all"
           class="px-4 py-2 rounded-md font-medium bg-[#3AB09E] text-white">
          All Products
        </a>
        <a id="filter-my"
           class="px-4 py-2 rounded-md font-medium bg-[#3AB09E] text-white">
          My Products
        </a>
      </div>

      <!-- Add Product button -->
      <button onclick="openProductModal()"
              class="mt-4 sm:mt-0 bg-[#3AB09E] hover:bg-[#39A78D] text-white px-6 py-2 rounded-md font-medium transition-colors">
        + Add Product
      </button>

      <button onclick="fetchProducts()"
        class="mt-4 sm:mt-0 bg-white/10 hover:bg-white/20 text-white px-6 py-2 rounded-md font-medium border border-white/30 transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 4v5h.582M20 20v-5h-.581M5.418 9A7.974 7.974 0 004 12c0 4.418 3.582 8 8 8
                  a7.971 7.971 0 005.657-2.343M18.581 15A7.974 7.974 0 0020 12c0-4.418-3.582-8-8-8
                  a7.971 7.971 0 00-5.657 2.343" />
        </svg>
        Refresh
      </button>
    </div>

    <!-- Product Grid / Empty State -->
    {% if not product_list %}
      <div class="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-12 text-center text-white shadow">
        <div class="w-32 h-32 mx-auto mb-4 opacity-90">
          <img src="{% static 'image/no_product.png' %}" alt="No product available" class="w-full h-full object-contain">
        </div>
        <h3 class="text-lg font-semibold mb-2">No product found</h3>
        <p class="text-white/80 mb-6">Add your first product and share it with the community.</p>
        <button onclick="openProductModal()" 
                class="inline-flex items-center px-5 py-2 bg-[#3AB09E] text-white rounded-md hover:bg-[#39A78D] transition-colors shadow">
          Add Product
        </button>
      </div>
    {% else %}
      <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for product in product_list %}
          {% include "card_product.html" with product=product %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<div id="loadingSpinner" class="hidden text-center text-white py-20">
  <div class="animate-spin w-10 h-10 border-4 border-white/20 border-t-[#3AB09E] mx-auto rounded-full mb-4"></div>
  <p>Loading products...</p>
</div>

<div id="errorMessage" class="hidden text-center bg-red-500/10 border border-red-500/30 text-red-300 rounded-xl p-8 shadow-md">
  <h3 class="text-lg font-semibold mb-2">Failed to load products</h3>
  <p class="text-sm mb-4">Please refresh or try again later.</p>
</div>

<div id="emptyStateDisplay" class="hidden text-center text-white/80 py-10">
  <div class="w-28 h-28 mx-auto mb-6">
    <img src="{% static 'image/no_product.png' %}" alt="No products" class="w-full h-full object-contain opacity-80">
  </div>
  <h3 class="text-lg font-semibold mb-2">No products found</h3>
  <p class="text-sm mb-6">Add one to get started.</p>
</div>

<script>
// ========= Global Variables =========
const PRODUCT_API = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ request.user.id|default_if_none:'' }}";

// Section Elements
const loadingSpinner = document.getElementById("loadingSpinner");
const errorMessage = document.getElementById("errorMessage");
const emptyStateDisplay = document.getElementById("emptyStateDisplay");
const productGridContainer = document.getElementById("productGrid");

// Filter Buttons
const filterAllBtn = document.getElementById("filter-all");
const filterMyBtn = document.getElementById("filter-my");

// State
let activeFilter = "all";
let allProducts = [];

// ========= Utility: Show/Hide Page Sections =========
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  if (loadingSpinner) loadingSpinner.classList.toggle("hidden", !showLoading);
  if (errorMessage) errorMessage.classList.toggle("hidden", !showError);
  if (emptyStateDisplay) emptyStateDisplay.classList.toggle("hidden", !showEmpty);
  if (productGridContainer)
    productGridContainer.classList.toggle("hidden", !showGrid);

  if (showGrid && productGridContainer) {
    productGridContainer.className =
      "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
  }
}

// ========= Utility: Readable Category =========
function getReadableCategoryName(code) {
  const mapping = {
    shoes: "Shoes",
    men_sportwear: "Men Sportwear",
    women_sportwear: "Women Sportwear",
    kids_sportwear: "Kids Sportwear",
    accessories: "Accessories",
    equipment: "Sports Equipment",
    bags: "Bags & Backpacks",
    outerwear: "Jackets & Hoodies",
  };
  return mapping[code] || code;
}

// ========= Build Product Card =========
function productCardElement(product) {
  const article = document.createElement("article");
  article.className =
    "relative rounded-2xl overflow-hidden bg-white/10 backdrop-blur-xl border border-white/20 shadow-lg hover:shadow-2xl transition duration-300 flex flex-col";

  const linkDetail = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace(
    "00000000-0000-0000-0000-000000000000",
    product.id
  );

  const name = DOMPurify.sanitize(product.name);
  const desc = DOMPurify.sanitize(product.descriptions);
  const categoryLabel = getReadableCategoryName(
    DOMPurify.sanitize(product.category)
  );
  const thumbnail = DOMPurify.sanitize(product.thumbnail || "");
  const price = Number(product.price).toLocaleString();
  const createdAt = new Date(product.date).toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
  const views = product.item_views;
  const isFeatured = product.is_featured;
  const isTrending = views > 20;

  const thumbnailHtml = thumbnail
    ? `<img src="${thumbnail}" alt="${name}" class="w-full h-56 object-cover opacity-90 hover:opacity-100 transition duration-300">`
    : `<div class="w-full h-56 bg-white/5 flex items-center justify-center text-sm text-white/60">No image</div>`;

  const featured = isFeatured
    ? `<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-500/30 text-yellow-200">Featured</span>`
    : "";
  const trending = isTrending
    ? `<span class="px-2 py-1 rounded text-xs font-medium bg-red-500/30 text-red-200">Trending</span>`
    : "";

  const ownerButtons =
    CURRENT_USER_ID &&
    Number(CURRENT_USER_ID) === Number(product.user_id)
      ? `<div class="flex space-x-3">
          <button type="button"
                  onclick="openEditModal('${product.id}')"
                  class="text-white/70 hover:text-white text-sm transition-colors">
            Edit
          </button>
          <button type="button"
                  onclick="openDeleteModal('${product.id}', '${product.name}')"
                  class="text-red-400 hover:text-red-500 text-sm transition-colors">
            Delete
          </button>
        </div>`
      : "";

  article.innerHTML = `
    <div class="aspect-video overflow-hidden relative">
      ${thumbnailHtml}
      <div class="absolute top-3 left-3 flex gap-2">
        <span class="px-2 py-1 rounded-md text-xs bg-[#3AB09E]/80 text-white">${categoryLabel}</span>
        ${featured}
        ${trending}
      </div>
    </div>
    <div class="p-6 flex flex-col flex-1 text-white">
      <div class="flex items-center text-sm text-white/70 mb-3">
        <time>${createdAt}</time>
        <span class="mx-2">â€¢</span>
        <span>${views} views</span>
      </div>
      <h3 class="text-xl font-bold mb-3 line-clamp-2 leading-tight">
        <a href="${linkDetail}" class="hover:text-[#3AB09E] transition-colors">${name}</a>
      </h3>
      <p class="text-white/80 text-sm leading-relaxed line-clamp-3 mb-4">${desc}</p>
      <div class="pt-4 border-t border-white/10 flex items-center justify-between">
        <a href="${linkDetail}" class="text-[#3AB09E] hover:text-[#39A78D] font-medium text-sm transition-colors">View details</a>
        ${ownerButtons}
      </div>
    </div>
  `;

  return article;
}

// ========= Render Products =========
function renderAllProducts(products) {
  productGridContainer.innerHTML = "";
  products.forEach((item) => {
    const card = productCardElement(item);
    productGridContainer.appendChild(card);
  });
}

// ========= Fetch & Filter Logic =========
async function fetchProducts() {
  try {
    displayPageSection({ showLoading: true });
    const res = await fetch(PRODUCT_API);
    if (!res.ok) throw new Error("Fetch failed");
    const data = await res.json();
    allProducts = data || [];

    if (allProducts.length === 0) {
      displayPageSection({ showEmpty: true });
      return;
    }

    renderFilteredProducts();
    if (typeof showToast === "function")
      showToast("Success", "Product list refreshed!", "success");
  } catch (err) {
    console.error(err);
    displayPageSection({ showError: true });
  }
}

function renderFilteredProducts() {
  updateButtonAppearance();

  const visibleProducts =
    activeFilter === "all"
      ? allProducts
      : allProducts.filter(
          (p) => Number(p.user_id) === Number(CURRENT_USER_ID)
        );

  if (visibleProducts.length === 0) {
    displayPageSection({ showEmpty: true });
    return;
  }

  displayPageSection({ showGrid: true });
  renderAllProducts(visibleProducts);
}

// ========= Update Button States =========
function updateButtonAppearance() {
  if (activeFilter === "all") {
    filterAllBtn.className =
      "px-4 py-2 rounded-md font-medium bg-[#3AB09E] text-white shadow-[0_4px_20px_rgba(58,176,158,0.2)]";
    filterMyBtn.className =
      "px-4 py-2 rounded-md font-medium bg-white text-gray-700 border border-gray-300 hover:bg-[#3AB09E]/80 hover:text-white transition";
  } else {
    filterAllBtn.className =
      "px-4 py-2 rounded-md font-medium bg-white text-gray-700 border border-gray-300 hover:bg-[#3AB09E]/80 hover:text-white transition";
    filterMyBtn.className =
      "px-4 py-2 rounded-md font-medium bg-[#3AB09E] text-white shadow-[0_4px_20px_rgba(58,176,158,0.2)]";
  }
}

// ========= Event Listeners =========
filterAllBtn.addEventListener("click", () => {
  activeFilter = "all";
  renderFilteredProducts();
});

filterMyBtn.addEventListener("click", () => {
  if (!CURRENT_USER_ID) {
    alert("Please log in to see your products.");
    return;
  }
  activeFilter = "my";
  renderFilteredProducts();
});

// ========= Init =========
fetchProducts();
document.addEventListener("productAdded", fetchProducts);
document.addEventListener("productUpdated", fetchProducts);
document.addEventListener("productDeleted", fetchProducts);
</script>
{% endblock %}