{% extends 'base.html' %}

{% block meta %}
<title>Register - Warung Football</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex"
     style="background:linear-gradient(135deg,#0f172a,#1e293b,#006D6F);">

  <!-- Left side -->
  <div class="flex-1 hidden lg:block"></div>

  <!-- Right side panel -->
  <div class="w-full lg:w-1/2 h-screen bg-white/10 backdrop-blur-xl 
              border-l border-white/20 shadow-xl text-white flex items-center justify-center">
    
    <div class="w-full max-w-md p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">Create Account</h2>
        <p class="text-white/80">Join Warung Football and enjoy our services</p>
      </div>

      <!-- Traditional Server Errors -->
      {% if form.errors %}
        <div class="mb-6 space-y-2">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <div class="px-4 py-3 rounded-md text-sm border bg-red-500/20 border-red-400 text-red-200">
                <strong>{{ field|title }}:</strong> {{ error }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endif %}

      <!-- AJAX States -->
      <div id="registerLoading" class="hidden flex items-center justify-center py-4 text-white/70">
        <div class="animate-spin w-6 h-6 border-2 border-white/30 border-t-[#3AB09E] mr-2 rounded-full"></div>
        Creating account...
      </div>

      <div id="registerEmpty" class="hidden py-12 text-center text-white/70">
        <h3 class="text-lg font-medium mb-2">Ready to Register</h3>
        <p class="empty-msg text-sm">Fill out the form to create your account.</p>
      </div>

      <div id="registerError" class="hidden p-4 bg-red-500/10 border border-red-400 text-red-200 rounded-md mb-6">
        <h3 class="text-sm font-medium mb-2">Registration Failed</h3>
        <p class="error-msg text-xs mb-4">Error details here.</p>
        <!-- No retry button -->
      </div>

      <div id="registerSuccess" class="hidden p-4 bg-green-500/10 border border-green-400 text-green-200 rounded-md mb-6">
        <h3 class="text-sm font-medium mb-2">Success!</h3>
        <p class="text-xs">Account created! Redirecting to login...</p>
      </div>

      <!-- Content (Form) -->
      <div id="registerContent">
        <form id="registerForm" method="POST" class="space-y-6">
          {% csrf_token %}
          
          <div>
            <label for="username" class="block text-sm font-medium mb-2">Username</label>
            <input id="username" name="username" type="text" required
                   class="w-full px-4 py-3 rounded-md bg-white/90 text-gray-900
                          focus:outline-none focus:ring-2 focus:ring-[#3AB09E]"
                   placeholder="Choose your username">
          </div>

          <div>
            <label for="password1" class="block text-sm font-medium mb-2">Password</label>
            <input id="password1" name="password1" type="password" required
                   class="w-full px-4 py-3 rounded-md bg-white/90 text-gray-900
                          focus:outline-none focus:ring-2 focus:ring-[#3AB09E]"
                   placeholder="Create a password">
          </div>

          <div>
            <label for="password2" class="block text-sm font-medium mb-2">Confirm Password</label>
            <input id="password2" name="password2" type="password" required
                   class="w-full px-4 py-3 rounded-md bg-white/90 text-gray-900
                          focus:outline-none focus:ring-2 focus:ring-[#3AB09E]"
                   placeholder="Repeat your password">
          </div>

          <button type="submit" id="registerSubmit"
                  class="w-full bg-[#3AB09E] hover:bg-[#39A78D] text-white font-medium py-3 px-4 rounded-md transition-colors">
            Create Account
          </button>
        </form>

        <!-- Footer -->
        <div class="mt-10 text-center border-t border-white/20 pt-6">
          <p class="text-white/70 text-sm">
            Already have an account? 
            <a href="{% url 'main:login' %}" class="text-[#3AB09E] hover:text-[#39A78D] font-medium">
              Sign In
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== AJAX REGISTER - No Retry ==========
console.log("=== AJAX REGISTER READY ===");

const form = document.getElementById("registerForm");
const content = document.getElementById("registerContent");
const loading = document.getElementById("registerLoading");
const empty = document.getElementById("registerEmpty");
const error = document.getElementById("registerError");
const success = document.getElementById("registerSuccess");
const submitBtn = document.getElementById("registerSubmit");

function showLoading() {
  content.classList.add("hidden");
  empty.classList.add("hidden");
  error.classList.add("hidden");
  success.classList.add("hidden");
  loading.classList.remove("hidden");
  submitBtn.disabled = true;
  submitBtn.textContent = "Creating Account...";
}

function showError(msg = "Registration failed") {
  content.classList.remove("hidden");
  loading.classList.add("hidden");
  empty.classList.add("hidden");
  success.classList.add("hidden");
  error.classList.remove("hidden");
  const msgEl = error.querySelector(".error-msg");
  if (msgEl) msgEl.textContent = msg;
  submitBtn.disabled = false;
  submitBtn.textContent = "Create Account";
}

function showSuccess() {
  loading.classList.add("hidden");
  empty.classList.add("hidden");
  error.classList.add("hidden");
  content.classList.add("hidden");
  success.classList.remove("hidden");
  submitBtn.disabled = true;
  submitBtn.textContent = "Account Created!";
}

if (form) {
  async function submitRegister() {
    console.log("=== REGISTER SUBMIT ===");

    showLoading();

    const formData = new FormData(form);
    const jsonData = {
      username: formData.get("username") || "",
      password1: formData.get("password1") || "",
      password2: formData.get("password2") || "",
      csrfmiddlewaretoken: formData.get("csrfmiddlewaretoken") || "",
    };

    try {
      const response = await fetch("{% url 'main:register' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
        },
        body: JSON.stringify(jsonData),
      });

      console.log("Status:", response.status);

      if (response.ok) {
        try {
          const result = await response.json();
          if (result.success) {
            showSuccess();
            if (typeof showToast === 'function') showToast("Success", "Account created!", "success");
            setTimeout(() => {
              window.location.href = result.redirect || "{% url 'main:login' %}";
            }, 1500);
            return;
          }
          throw new Error(result.message || result.errors?.[0] || "Registration failed");
        } catch (jsonErr) {
          // Fallback HTML
          console.log("Non-JSON - assuming success");
          showSuccess();
          if (typeof showToast === 'function') showToast("Success", "Account created!", "success");
          setTimeout(() => {
            window.location.href = "{% url 'main:login' %}";
          }, 1500);
          return;
        }
      } else {
        try {
          const errData = await response.json();
          const msg = errData.message || errData.errors?.[0] || "Registration failed";
          throw new Error(msg);
        } catch {
          const text = await response.text();
          const msg = text.includes("taken") ? "Username already exists" : "Server error";
          throw new Error(msg);
        }
      }
    } catch (err) {
      console.error("Register error:", err);
      showError(err.message);
      if (typeof showToast === 'function') showToast("Error", err.message, "error");
    }
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    submitRegister();
  });
} else {
  console.warn("No form");
}

// Initial form
content.classList.remove("hidden");
console.log("=== AJAX REGISTER READY ===");
</script>
{% endblock content %}